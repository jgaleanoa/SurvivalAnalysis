---
header-includes:
- \usepackage{longtable}
- \usepackage[utf8]{inputenc}
- \usepackage[spanish]{babel}\decimalpoint
- \setlength{\parindent}{1.25cm}
- \usepackage{amsmath}
- \usepackage{xcolor}
- \usepackage{cancel}
- \usepackage{array}
- \usepackage{float}
- \usepackage{multirow}
output:
  pdf_document: 
    number_sections: yes
fontsize: 12pt
papersize: letter
geometry: margin = 1in
language: "es"
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, fig.align = "center",
                      fig.height = 3.2, fig.pos = "H")
library(kableExtra)
library(knitr)
library(tidyverse)
library(magrittr)
library(latex2exp)
library(ggfortify)
library(survival)
library(survminer)
library(gridExtra)
```

```{=tex}
\input{titlepage}
\thispagestyle{empty}
\tableofcontents
\newpage
\thispagestyle{empty}
\listoffigures
\newpage
```

```{=tex}
\pagestyle{myheadings}
\setcounter{page}{4}
```

\section{Ejercicio 1}

\subsection{Literal a}

Si se realiza un seguimiento durante 13 años a un grupo de adultos de al menos 60 años de edad para ver qué tanto tiempo permanecen vivos, el evento de interés en este caso es la muerte del adulto, además, la variable respuesta queda definida como: Tiempo que transcurre hasta que el adulto muere. En este caso se tiene que el tiempo de censura es fijo (13 años).

\subsection{Literal b}

Por otro lado, si un grupo de pacientes con un trasplante de corazón son monitoreados para ver cuánto tiempo sobreviven, el evento de interés es la muerte del paciente y la variable respuesta es el tiempo que pasa hasta que el paciente muere por complicaciones relacionadas a su trasplante.

\section{Ejercicio 2}

Se dispone de una base de datos relacionada a la Hepatitis Crónica Activa (CAH). Especificamente se tienen observaciones de 44 pacientes con dicha enfermedad, los cuales fueron divididos aleatoriamente en dos grupos donde el primero de ellos se corresponde a pacientes con la enfermedad a los cuales se les suministró un medicamento llamado prednisolona. Al segundo grupo o grupo de control, no se le proporcionó algún tipo de tratamiento. Los datos se ilustran a continuación:

```{r cargando datos}
CAH <- read.table("CAH.txt", header = T)
colnames(CAH) <- c("ID", "Grupo", "Tiempo", "Censura")
kable(head(CAH), caption="Disposición de los datos", align = 'c', longtable = T, booktab = T)
```

De allí, el tiempo de supervivencia se encuentra en unidades de meses.

Con lo anterior, es de interés construir un estimador para $S(t)$ utilizando el estimador de Kaplan-Meier y el estimador de Nelson-Aalen.

\subsection{Análisis descriptivo}

Antes de comenzar el desarrollo para construir el estimador para $S(t)$, es conveniente hacer un rápido análisis descriptivo que de indicios primarios del comportamiento de los grupos de control y bajo la influencia de la Prednisolona. Por lo tanto se plantea el siguiente gráfico de cajas:

```{r EDAED, fig.cap="Análisis descriptivo"}
ggplot(CAH,aes(y=Tiempo,x=factor(Grupo),group=factor(Grupo),fill=factor(Grupo)))+
  geom_boxplot()+
  stat_summary(aes(y=Tiempo,x=factor(Grupo)),fun=mean, geom="point", shape=20, 
               size=4, color="yellow")+
  labs(x="", y="Semanas", title="Grupos vs tiempos de falla",fill="Grupo")+
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5))
```
De este último se puede apreciar inicialmente que el grupo 1 (al cual se le está proporcionando el medicamento), parece tener tiempos de falla superiores al grupo de control, lo cual indica que es esperable una supervivencia mayor en el mismo respecto al grupo 2. Sin embargo, se puede pensar que la diferencia mencionada anteriormente puede no ser estadísticamente significativa, por lo cuál no se puede concluir terminantemente a partir de este gráfico.

\newpage
\subsection{Obteniendo el estimador de Kaplan-Meier}

Hecho lo anterior, para iniciar con el desarrollo, se deben organizar los tiempos de falla para cada grupo por separado así:

```{r construyendo km1}
KM_df_g1 <- data.frame(tj = c(0,unique(subset(CAH, subset = Grupo==1 & Censura == 1)$Tiempo)))
colnames(KM_df_g1) <- c("$t_j$")

KM_df_g2 <- data.frame(tj = c(0, unique(subset(CAH, subset = Grupo==2 & Censura == 1)$Tiempo)))
colnames(KM_df_g2) <- c("$t_j$")

kable(
  list(KM_df_g1, KM_df_g2),
  caption = 'Tiempos ordenados grupos 1 y 2',
  booktab = T, 
  align = 'c',
  escape = F
)%>%
  kable_styling(latex_options = "HOLD_position")


```

Seguidamente, se debe contar el número de pacientes bajo observación y a riesgo "$n_j$" en el j-ésimo intervalo. Se obtiene las siguientes tablas por grupo:

```{r construyendo km2}
KM_df_g1 <- cbind(KM_df_g1, nj = c(22,22,20,19,17,16,15,8,6,3))
colnames(KM_df_g1) <- c("$t_j$", "$n_j$")

KM_df_g2 <- cbind(KM_df_g2, nj = c(22,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7))
colnames(KM_df_g2) <- c("$t_j$", "$n_j$")

kable(
  list(KM_df_g1, KM_df_g2),
  caption = 'Estimando S(t) grupos 1 y 2',
  booktab = T, 
  align = 'c',
  escape = F
)%>%
  kable_styling(latex_options = "HOLD_position")

```

Posteriormente, se deben calcular el número de fallas "$d_j$" en cada intervalo. La construcción de cada tabla por grupo se sigue mostrando a continuación:

```{r construyendo km3}
KM_df_g1 <- cbind(KM_df_g1, dj = c(0,2,1,1,1,1,2,1,1,1))
colnames(KM_df_g1) <- c("$t_j$", "$n_j$", "$d_j$")

KM_df_g2 <- cbind(KM_df_g2, dj = c(0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1))
colnames(KM_df_g2) <- c("$t_j$", "$n_j$", "$d_j$")

kable(
  list(KM_df_g1, KM_df_g2),
  caption = 'Estimando S(t) grupos 1 y 2',
  booktab = T, 
  align = 'c',
  escape = F
)%>%
  kable_styling(latex_options = "HOLD_position")
```

Así, antes de proceder a calcular la estimación de la supervivencia en cada intervalo, en vías de determinar si la construcción de la tabla es correcta, se procede a calcular el número de censuras "$q_j$" y se obtiene la siguiente tabla:

```{r construyendo km4}
KM_df_g1 <- cbind(KM_df_g1, qj = c(0,0,0,1,0,0,5,1,2,2))
colnames(KM_df_g1) <- c("$t_j$", "$n_j$", "$d_j$", "$q_j$")

KM_df_g2 <- cbind(KM_df_g2, qj = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6))
colnames(KM_df_g2) <- c("$t_j$", "$n_j$", "$d_j$", "$q_j$")

kable(
  list(KM_df_g1, KM_df_g2),
  caption = 'Estimando S(t) grupos 1 y 2',
  booktab = T, 
  align = 'c',
  escape = F
)%>%
  kable_styling(latex_options = "HOLD_position")
```

Con esto, se logra ver que la suma de las columnas "$d_j$" y "$q_j$" suman 22 en cada grupo, que se corresponde con el número de pacientes en cada uno de los mismos. Por lo cual, se puede concluir que la construcción de la tabla es correcta. 

Finalmente, para obtener la estimación de la supervivencia en cada intervalo para cada grupo, se hace uso del estimador de Kaplan-Meier, el cual se encuentra definido de la siguiente manera:

$$
\hat{S}_{KM}(t) = \prod_{j:t_j\leq t}\left[1-\frac{d_j}{n_j}\right]
$$
Con esto último, se tiene que para el primer grupo:

\begin{itemize}
\item Para $t_j = 0$, $\hat{S}_{KM}(0) = (1-0/22) = 1$
\item Para $t_j = 2$, $\hat{S}_{KM}(2) = 1 \times (1-2/22) = 0.9091$
\item Para $t_j = 12$, $\hat{S}_{KM}(12) = 0.9091 \times (1-1/20) = 0.8636$
\item Para $t_j = 54$, $\hat{S}_{KM}(54) = 0.8636 \times (1-1/19) = 0.8181$
\item Para $t_j = 68$, $\hat{S}_{KM}(68) = 0.8181 \times (1-1/17) = 0.7700$
\item Para $t_j = 89$, $\hat{S}_{KM}(89) = 0.7700 \times (1-1/16) = 0.7219$
\item Para $t_j = 96$, $\hat{S}_{KM}(96) = 0.7219 \times (1-2/15) = 0.6257$
\item Para $t_j = 143$, $\hat{S}_{KM}(143) = 0.6257 \times (1-1/8) = 0.5475$
\item Para $t_j = 146$, $\hat{S}_{KM}(146) = 0.5475 \times (1-1/6) = 0.4562$
\item Para $t_j = 168$, $\hat{S}_{KM}(168) = 0.4562 \times (1-1/3) = 0.3041$
\end{itemize}

Y para el segundo grupo:

\begin{itemize}
\item Para $t_j = 0$, $\hat{S}_{KM}(0) = (1-0/22) = 1$
\item Para $t_j = 2$, $\hat{S}_{KM}(2) = 1 \times (1-1/22) = 0.9545$
\item Para $t_j = 3$, $\hat{S}_{KM}(3) = 0.9545 \times (1-1/21) = 0.9091$
\item Para $t_j = 4$, $\hat{S}_{KM}(4) = 0.9091 \times (1-1/20) = 0.8636$
\item Para $t_j = 7$, $\hat{S}_{KM}(7) = 0.8636 \times (1-1/19) = 0.8181$
\item Para $t_j = 10$, $\hat{S}_{KM}(10) = 0.8181 \times (1-1/18) = 0.7727$
\item Para $t_j = 22$, $\hat{S}_{KM}(22) = 0.7727 \times (1-1/17) = 0.7272$
\item Para $t_j = 28$, $\hat{S}_{KM}(28) = 0.7272 \times (1-1/16) = 0.6818$
\item Para $t_j = 29$, $\hat{S}_{KM}(29) = 0.6818 \times (1-1/15) = 0.6364$
\item Para $t_j = 32$, $\hat{S}_{KM}(32) = 0.6364 \times (1-1/14) = 0.5909$
\item Para $t_j = 37$, $\hat{S}_{KM}(37) = 0.5909 \times (1-1/13) = 0.5455$
\item Para $t_j = 40$, $\hat{S}_{KM}(40) = 0.5455 \times (1-1/12) = 0.5$
\item Para $t_j = 41$, $\hat{S}_{KM}(41) = 0.5 \times (1-1/11) = 0.4545$
\item Para $t_j = 54$, $\hat{S}_{KM}(54) = 0.4545 \times (1-1/10) = 0.4091$
\item Para $t_j = 61$, $\hat{S}_{KM}(61) = 0.4091 \times (1-1/9) = 0.3636$
\item Para $t_j = 63$, $\hat{S}_{KM}(63) = 0.3636 \times (1-1/8) = 0.3182$
\item Para $t_j = 71$, $\hat{S}_{KM}(71) = 0.3182 \times (1-1/7) = 0.2727$
\end{itemize}

Y así, finalmente se obtienen las tablas de vida con la estimación de $S(t)$ para cada grupo como se muestra a continuación:

```{r construyendo km5}
KM_df_g1 <- cbind(KM_df_g1, skm = c("1",0.9091,0.8636,0.8181,0.7700,0.7219,0.6257,0.5475,0.4562,0.3041))
colnames(KM_df_g1) <- c("$t_j$", "$n_j$", "$d_j$", "$q_j$", "$\\hat{S}_{KM}(t_j)$")

KM_df_g2 <- cbind(KM_df_g2, 
                  skm = c("1",0.9545,0.9091,0.8636,0.8181,0.7727,0.7272,0.6818,0.6364,0.5909,0.5455,0.5,0.4545,0.4091,0.3636,0.3182,0.2727))
colnames(KM_df_g2) <- c("$t_j$", "$n_j$", "$d_j$", "$q_j$", "$\\hat{S}_{KM}(t_j)$")

kable(
  list(KM_df_g1, KM_df_g2),
  caption = 'Tablas de vida grupos 1 y 2',
  booktab = T, 
  align = 'c',
  escape = F
)%>%
  kable_styling(latex_options = "HOLD_position")
```

A primera vista se puede apreciar de las anteriores tablas que, el grupo de control parece tener una supervivencia menor respecto al grupo al cual se le proporcionó la Prednisolona. Más puntualmente, se nota que a partir de la semana 71, la probabilidad de supervivencia en este grupo es de 0.2727, lo cual es un resultado muy inferior respecto a lo conseguido en el grupo con medicación. Sin embargo, el comportamiento de los dos grupos no es muy claro a partir del resultado anterior, por ende, se pueden graficar las respectivas curvas de supervivencia estimadas como se muestra:

\begin{figure}[H]
  \includegraphics{KMbyhandplot.jpg}
  \caption{Curvas de supervivencia con KM}
\end{figure}

De este gráfico se aprecia que, el estimador de Kaplan-Meier para la supervivencia indica que el grupo de control comienza a disminuír su supervivencia respecto al grupo medicado, a partir de la semana 25 aproximadamente, lo cual puede sugerir un efecto positivo de la prednisolona en el otro grupo. Sin embargo, este análisis preliminar debe ser comprobado estadísticamente mediante alguna prueba formal.

\subsection{Usando el estimador de Nelson-Aalen}

Motivado por la siguiente relación:

$$
\hat{S}_{KM}(t) \approx e^{-\hat{H}_{NA}(t)}
$$
El procedimiento anterior para obtener la curva de supervivencia en ambos grupos se puede desarrollar iniciando por estimar $H(t)$ mediante el estimador de Nelson-Aalen. Para este procedimiento se deben organizar las fallas para cada grupo como sigue:

```{r construyendo na1}
NA_df_g1 <- data.frame(Falla = c("1-2",3,4,5,6,"7-8",9,10,11),
                       Meses = c(2,12,54,68,89,96,143,146,168))

NA_df_g2 <- data.frame(Falla = c(1:16),
                       Meses = c(2,3,4,7,10,22,28,29,32,37,40,41,54,61,63,71))

kable(
  list(NA_df_g1, NA_df_g2),
  caption = 'Estimador de Nelson-Aalen grupos 1 y 2',
  booktab = T, 
  align = 'c',
  escape = F
)%>%
  kable_styling(latex_options = "HOLD_position")
```

Seguidamente es necesario calcular la cantidad:

$$
\frac{\Delta\bar{N}(t_i)}{\bar{Y}(t_i)}=\frac{\text{Número de fallas en el intervalo }(t_i,t_{i+1})}{\text{Número de unidades bajo observación y a riesgo a }t_i}
$$
Así, para el grupo 1 se tiene que:

\begin{itemize}
\item $\hat{h}(2) = 2/22$
\item $\hat{h}(12) = 1/20$
\item $\hat{h}(54) = 1/19$
\item $\hat{h}(68) = 1/17$
\item $\hat{h}(89) = 1/16$
\item $\hat{h}(96) = 2/15$
\item $\hat{h}(143) = 1/8$
\item $\hat{h}(146) = 1/6$
\item $\hat{h}(2) = 1/3$
\end{itemize}

Y para el grupo 2:

\begin{itemize}
\item $\hat{h}(2) = 1/22$
\item $\hat{h}(3) = 1/21$
\item $\hat{h}(4) = 1/20$
\item $\hat{h}(7) = 1/19$
\item $\hat{h}(10) = 1/18$
\item $\hat{h}(22) = 1/17$
\item $\hat{h}(28) = 1/16$
\item $\hat{h}(29) = 1/15$
\item $\hat{h}(32) = 1/14$
\item $\hat{h}(37) = 1/13$
\item $\hat{h}(40) = 1/12$
\item $\hat{h}(41) = 1/11$
\item $\hat{h}(54) = 1/10$
\item $\hat{h}(61) = 1/9$
\item $\hat{h}(63) = 1/8$
\item $\hat{h}(71) = 1/7$
\end{itemize}

Finalmente, para obtener $\hat{H}_{NA}(t)$ para cada grupo, basta con hacer una suma acumulativa de lo obtenido anteriormente. Por lo tanto, la tabla para el estimador de Nelson-Aalen en cada grupo queda así:

```{r construyendo na2}
NA_df_g1 <- cbind(NA_df_g1, ht = round(c(2/22,1/20,1/19,1/17,1/16,2/15,1/8,1/6,1/3),4),
                  Ht = round(cumsum(c(2/22,1/20,1/19,1/17,1/16,2/15,1/8,1/6,1/3)),4))
colnames(NA_df_g1) <- c("Falla","Meses","$\\hat{h}(t)$","$\\hat{H}_{NA}(t)$")

NA_df_g2 <- cbind(NA_df_g2, ht = round(1/22:7,4),
                  Ht = round(cumsum(c(1/22:7)),4))
colnames(NA_df_g2) <- c("Falla","Meses","$\\hat{h}(t)$","$\\hat{H}_{NA}(t)$")

kable(
  list(NA_df_g1, NA_df_g2),
  caption = 'Estimador de Nelson-Aalen grupos 1 y 2',
  booktab = T, 
  align = 'c',
  escape = F
)%>%
  kable_styling(latex_options = "HOLD_position")

```
Con ambas tablas totalmente construídas y mediante la relación $\hat{S}_{KM}(t) \approx e^{-\hat{H}_{NA}(t)}$, se puede obtener una estimación de la supervivencia como sigue:

```{r construyendo na3}
NA_df_g1 <- cbind(NA_df_g1, st = round(exp(-NA_df_g1[,4]),4))
colnames(NA_df_g1) <- c("Falla","Meses","$\\hat{h}(t)$","$\\hat{H}_{NA}(t)$",
                        "$e^-\\hat{H}_{NA}(t)$")

NA_df_g2 <- cbind(NA_df_g2, st = round(exp(-NA_df_g2[,4]),4))
colnames(NA_df_g2) <- c("Falla","Meses","$\\hat{h}(t)$","$\\hat{H}_{NA}(t)$",
                        "$e^-\\hat{H}_{NA}(t)$")

kable(
  list(NA_df_g1, NA_df_g2),
  caption = 'Estimación de la supervivencia grupos 1 y 2',
  booktab = T, 
  align = 'c',
  escape = F
)%>%
  kable_styling(latex_options = "HOLD_position")

```
Si se aprecia con detenimiento estas tablas para la estimación de $S(t)$, se puede notar el gran parecido con las tablas construídas directamente con el estimador de Kaplan-Meier. Esto da cuenta de que se pueden llegar a conclusiones similares usando distintos caminos de estimación, sin embargo se debe tener en cuenta siempre que la relación planteada entre el hazard acumulado y la supervivencia es naturalmente aproximada y por lo tanto hay que ser cautelosos con la precisión y las conclusiones.

Para visualizar de manera adecuada la estimación obtenida, se procede a graficar los datos como sigue:

\begin{figure}[H]
  \includegraphics{NAbyhandplot.jpg}
  \caption{Curvas de supervivencia con NA}
\end{figure}

El gráfico obtenido por este método permite concluir de manera muy similar a lo obtenido con el estimador de Kaplan-Meier. Parece que el estimador de Nelson-Aalen captura el mismo comportamiento entre los grupos, sugiriendo de este modo que el medicamento parece aumentar la supervivencia de los pacientes con hepatitis. Nuevamente se sugiere el uso de una prueba estadística para detectar diferencia entre las curvas. Dicha prueba debería ser robusta frente a la similaridad de las curvas para cada grupo al principio y al final del experimento. 

\newpage
\section{Ejercicio 3}

Todo el desarrollo realizado en el punto anterior, se puede implementar fácilmente mediante el paquete `survival` de R. Las tablas de vida calculadas anteriormente se presentan como sigue:

```{r replicando con paquete survival}
Y <- Surv(time = CAH$Tiempo, event = CAH$Censura == 1)

kmfit <- survfit(Y ~ CAH$Grupo)

summ <- summary(kmfit, censored=FALSE)

KM_df_g1_surv <- data.frame(tj = summ$time[1:9], nj = summ$n.risk[1:9],
                            dj = summ$n.event[1:9], summ$n.censor[1:9],
                            st = round(summ$surv[1:9],4))

KM_df_g2_surv <- data.frame(tj = summ$time[10:25], nj = summ$n.risk[10:25],
                            dj = summ$n.event[10:25], summ$n.censor[10:25],
                            st = round(summ$surv[10:25],4))

colnames(KM_df_g1_surv) <- c("$t_j$", "$n_j$", "$d_j$", "$q_j$", "$\\hat{S}_{KM}(t_j)$")
colnames(KM_df_g2_surv) <- c("$t_j$", "$n_j$", "$d_j$", "$q_j$", "$\\hat{S}_{KM}(t_j)$")

kable(
  list(KM_df_g1_surv, KM_df_g2_surv),
  caption = 'Tablas de vida Grupos 1 y 2 Vía KM',
  booktab = T, 
  align = 'c',
  escape = F
)%>%
  kable_styling(latex_options = "HOLD_position")
```

Este resultado concuerda con lo obtenido a mano. 

La gran ventaja de usar el paquete survival para realizar estimaciones sobre la supervivencia, es que esta herramienta permite graficar de una forma muy adecuada los resultado, y asimismo comparar el comportamiento de la supervivencia en ambos grupos. A continuación se presenta el gráfico con las curvas de supervivencia para cada grupo:

```{r Graficando con survival, fig.cap="Curvas de supervivencia con KM"}
KM_fit <- survfit(Surv(Tiempo, Censura) ~ Grupo, data = CAH)

autoplot(KM_fit, type="fill",surv.alpha=0.9, 
         surv.size=2,
         conf.int.alpha=0.2,
         censor.size=5,
         censor.colour="purple")+ 
  labs(x = "\n Tiempo de Supervivencia (Meses) ", y = "Probabilidad de supervivencia \n", 
       title = "Curvas de Supervivencia Estimadas Para \n Pacientes de Hepatitis usando KM") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))
```
De este gráfico se aprecia inicialmente que, tanto al principio como al final del experimento, las curvas parecen juntarse lo suficiente para pensar que no hay suficiente diferencia entre los grupos de control y medicado. Sin embargo, este comportamiento ocurre durante muy poco tiempo, y para los tiempos de supervivencia entre 25 y 150 meses, las curvas se alejan sistemáticamente, lo cual indica un posible efecto del medicamento. Específicamente se nota una disminución muy marcada de la supervivencia en el grupo de control comparado con el grupo al cual se le suministró prednisolona, lo cual podría dar indicios de efectividad en el medicamento. No obstante, esta diferencia entre las curvas debe probarse estadísticamente con una prueba formal.

El paquete survival también permite, mediante la función `survfit()`, obtener estimaciones del hazard acumulado. Conociendo además la relación mencionada anteriormente entre el hazard acumulado y la supervivencia, las tablas de vida se pueden obtener como sigue:

```{r replicando con paquete survival2}
NA_df_g1_surv <- data.frame(tj = round(summ$time[1:9],4) ,
                            cumhaz = round(summ$cumhaz[1:9],4),
                            st = round(exp(-summ$cumhaz[1:9]),4))

NA_df_g2_surv <- data.frame(tj = round(summ$time[10:25],4),
                            cumhaz = round(summ$cumhaz[10:25],4),
                            st = round(exp(-summ$cumhaz[10:25]),4))

colnames(NA_df_g1_surv) <- c("$t_j$","$\\hat{H}_{NA}(t)$","$e^-\\hat{H}_{NA}(t)$")
colnames(NA_df_g2_surv) <- c("$t_j$","$\\hat{H}_{NA}(t)$","$e^-\\hat{H}_{NA}(t)$")

kable(
  list(NA_df_g1_surv, NA_df_g2_surv),
  caption = 'Tablas de vida Grupos 1 y 2 Vía NA',
  booktab = T, 
  align = 'c',
  escape = F
)%>%
  kable_styling(latex_options = "HOLD_position")
```
Este resultado concuerda perfectamente con lo obtenido a mano.

También se puede graficar el resultado usando esta aproximación:

```{r Graficando con survival2, fig.cap="Curvas de supervivencia con NA"}
NA_df_g1_surv <- data.frame(tj = round(c(summ$time[1:9],182),4) ,
                            cumhaz = round(c(summ$cumhaz[1:9],1.07319753),4),
                            st = round(exp(-c(summ$cumhaz[1:9],1.07319753)),4))

NA_df_g2_surv <- data.frame(tj = round(c(summ$time[10:25],182),4),
                            cumhaz = round(c(summ$cumhaz[10:25],1.24081325),4),
                            st = round(exp(-c(summ$cumhaz[10:25],1.24081325)),4))

ggplot(NA_df_g1_surv, aes(tj,st)) + 
  geom_step(size=2, color = "pink")+ 
  geom_step(aes(tj,st),data = NA_df_g2_surv, size = 2, color = "lightblue", direction = "vh")+ 
  labs(x = "\n Tiempo de Supervivencia (Meses) ", y = "Probabilidad de supervivencia \n", 
       title = "Curvas de Supervivencia Estimadas Para \n Pacientes de Hepatitis usando NA") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold",  size = 12),
        axis.title.y = element_text(face="bold",  size = 12),
        legend.title = element_text(face="bold", size = 10))
```
De este par de curvas se puede concluir de manera homóloga a lo obtenido usando el estimador de Kaplan-Meier, puesto que se evidencia exactamente el mismo comportamiento en las mismas en este caso usando la relación $\hat{S}_{KM}(t) \approx e^{-\hat{H}_{NA}(t)}$. Sin embargo, nuevamente se debe proceder con cuidado ante esta aproximación a la hora de dar recomendaciones.

\section{Ejercicio 4}
\subsection{Estimador del Hazard Integrado}
Tomando la siguiente relación:

$$
\hat{H}(t) \approx -log(\hat{S}_{KM}(t))
$$
Se procede a construir y a calcular manualmente.
 $\hat{s}_{KM}(t)$

```{r construyendo -log(km)1}
tj_g1 <- c(0, 2, 12, 54, 68, 89, 96, 143, 146, 168)
nj_g1 <- c(22, 22, 20, 19, 17, 16, 15, 8, 6, 3)
dj_g1 <- c(0, 2, 1, 1, 1, 1, 2, 1, 1, 1)
qj_g1 <- c(0, 0, 0, 1, 0, 0, 5, 1, 2, 2)

less_log_KM_df_g1 <- cbind(tj_g1, nj_g1, dj_g1, qj_g1)
colnames(less_log_KM_df_g1) <- c("$t_j$", "$n_j$", "$d_j$", "$q_j$")

tj_g2 <- c(0, 2, 3, 4, 7, 10 , 22, 28, 29, 32, 37, 40, 41, 54, 61, 63, 71)
nj_g2 <- c(22, 22, 21, 20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7)
dj_g2 <- c(0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)
qj_g2 <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6)


less_log_KM_df_g2 <- cbind(tj_g2, nj_g2, dj_g2, qj_g2)
colnames(less_log_KM_df_g2) <- c("$t_j$", "$n_j$", "$d_j$", "$q_j$")

kable(
  list(less_log_KM_df_g1, less_log_KM_df_g2),
  caption = 'Estimando S(t) grupos 1 y 2',
  booktab = T, 
  align = 'c',
  escape = F
)%>%
  kable_styling(latex_options = "HOLD_position")
```
Finalmente, para obtener la estimación del Hazard integrado $\hat{H(t)}$ en cada intervalo para cada grupo, se hace uso del estimador de Kaplan-Meier aplicando. $-log(\hat{S}_{KM}(t))$. Esto es:

$$
-log(\hat{S}_{KM}(t)) = -\sum_{j:t_j\leq t} log \left [1-\frac{d_j}{n_j}\right]\
$$
\begin{itemize}
\item Para $t_j = 0$, $-log(\hat{S}_{KM}(0)) = -log(1-0/22) = 0$
\item Para $t_j = 2$, $-log(\hat{S}_{KM}(2)) = 0 - log(1-2/22) = 0.0953$
\item Para $t_j = 12$, $-log(\hat{S}_{KM}(12)) = 0.0953  -log(1-1/20) = 0.1466$
\item Para $t_j = 54$, $-log(\hat{S}_{KM}(54)) = 0.1466  -log(1-1/19) = 0.2007$
\item Para $t_j = 68$, $-log(\hat{S}_{KM}(68)) = 0.2007 -log(1-1/17) = 0.2613$
\item Para $t_j = 89$, $-log(\hat{S}_{KM}(89)) = 0.2613 -log(1-1/16) = 0.3258$
\item Para $t_j = 96$, $-log(\hat{S}_{KM}(96)) = 0.3258 -log(1-2/15) = 0.4689$
\item Para $t_j = 143$, $-log(\hat{S}_{KM}(143)) = 0.4689 -log(1-1/8) = 0.6024$
\item Para $t_j = 146$, $-log(\hat{S}_{KM}(146)) = 0.6024 -log(1-1/6) = 0.7847$
\item Para $t_j = 168$, $-log(\hat{S}_{KM}(168)) = 0.7847 -log(1-1/3) = 1.1902$
\end{itemize}

Y para el segundo grupo:

\begin{itemize}
\item Para $t_j = 0$, $-log(\hat{S}_{KM}(0)) = -log(1-0/22) = 0$
\item Para $t_j = 2$, $-log(\hat{S}_{KM}(2)) = 0 -log(1-1/22) = 0.0465$
\item Para $t_j = 3$, $-log(\hat{S}_{KM}(3)) = 0.0465 -log(1-1/21) = 0.0953$
\item Para $t_j = 4$, $-log(\hat{S}_{KM}(4)) = 0.0953 -log(1-1/20) = 0.1466$
\item Para $t_j = 7$, $-log(\hat{S}_{KM}(7)) = 0.1466 -log(1-1/19) = 0.2007$
\item Para $t_j = 10$, $-log(\hat{S}_{KM}(10)) = 0.2007 -log(1-1/18) = 0.2578$
\item Para $t_j = 22$, $-log(\hat{S}_{KM}(22)) = 0.2578 -log(1-1/17) = 0.3185$
\item Para $t_j = 28$, $-log(\hat{S}_{KM}(28)) = 0.3185 -log(1-1/16) = 0.3830$
\item Para $t_j = 29$, $-log(\hat{S}_{KM}(29)) = 0.3830 -log(1-1/15) = 0.4520$
\item Para $t_j = 32$, $-log(\hat{S}_{KM}(32)) = 0.4520 -log(1-1/14) = 0.5261$
\item Para $t_j = 37$, $-log(\hat{S}_{KM}(37)) = 0.5261 -log(1-1/13) = 0.6061$
\item Para $t_j = 40$, $-log(\hat{S}_{KM}(40)) = 0.6061 -log(1-1/12) = 0.6931$
\item Para $t_j = 41$, $-log(\hat{S}_{KM}(41)) = 0.6931 -log(1-1/11) = 0.7885$
\item Para $t_j = 54$, $-log(\hat{S}_{KM}(54)) = 0.7885 -log(1-1/10) = 0.8938$
\item Para $t_j = 61$, $-log(\hat{S}_{KM}(61)) = 0.8938 -log(1-1/9) = 1.0116$
\item Para $t_j = 63$, $-log(\hat{S}_{KM}(63)) = 1.0116 -log(1-1/8) = 1.1451$
\item Para $t_j = 71$, $-log(\hat{S}_{KM}(71)) = 1.1451 -log(1-1/7) = 1.2993$
\end{itemize}

```{r construyendo -log(km)2}
tj_g1 <- c(0, 2, 12, 54, 68, 89, 96, 143, 146, 168)
nj_g1 <- c(22, 22, 20, 19, 17, 16, 15, 8, 6, 3)
dj_g1 <- c(0, 2, 1, 1, 1, 1, 2, 1, 1, 1)
qj_g1 <- c(0, 0, 0, 1, 0, 0, 5, 1, 2, 2)
less_log_g1 <- c(0, 0.0953, 0.1466, 0.2007, 0.2613, 0.3258, 0.4689, 0.6025, 0.7848, 1.1903)

less_log_KM_df_g1 <- cbind(tj_g1, nj_g1, dj_g1, qj_g1, less_log_g1)
colnames(less_log_KM_df_g1) <- c("$t_j$", "$n_j$", "$d_j$", "$q_j$", "$-log( \\hat{S}(t) ) $")

tj_g2 <- c(0, 2, 3, 4, 7, 10 , 22, 28, 29, 32, 37, 40, 41, 54, 61, 63, 71)
nj_g2 <- c(22, 22, 21, 20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7)
dj_g2 <- c(0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)
qj_g2 <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6)
less_log_g2 <-c(0, 0.0465, 0.0953, 0.1466, 0.2007, 0.2578, 0.3185, 0.3830, 0.4520, 0.5261, 0.6061, 0.6931, 0.7885, 0.8938, 1.0116, 1.1451, 1.2993)

less_log_KM_df_g2 <- cbind(tj_g2, nj_g2, dj_g2, qj_g2, less_log_g2)
colnames(less_log_KM_df_g2) <- c("$t_j$", "$n_j$", "$d_j$", "$q_j$", "$-log( \\hat{S}(t) ) $")

kable(
  list(less_log_KM_df_g1, less_log_KM_df_g2),
  caption = 'Estimando H(t) grupos 1 y 2',
  booktab = T, 
  align = 'c',
  escape = F
)%>%
  kable_styling(latex_options = "HOLD_position")
```

Con una vista rápida a la tabla anterior se puede evidenciar que el grupo de control (grupo2) tiene un  mayor número de fallas en promedio. Respecto al grupo que se les suministra prednisolona(grupo1).


\begin{figure}[H]
  \includegraphics{H_-log_KM.jpeg}
  \caption{Hazard acumulado usando -log(KM)}
\end{figure}

Con el gráfico estimado manualmente se puede apreciar que tan rápido crece en promedio la posibilidad de falla en el grupo de control(grupo2). Respecto al grupo tratado con prednisolona(grupo1).

\newpage
\subsection{Estimador de Nelson-Aalen}

Se procede a construir y a calcular manualmente el estimador $\hat{H}_{NA}(t)$

```{r, construyendo NA}
fallas_g1 <- c("1-2", "3", "4", "5", "6", "7-8", "9", "10", "11")
meses_g1 <- c(2, 12, 54, 68, 89, 96, 143, 146, 168)
h_g1 <-c("2/12 = 0.0909", "1/20 = 0.0500", "1/19=0.0526", "1/17 = 0.0588", "1/16 = 0.0625", "2/15 = 0.1333", "1/8 = 0.1250","1/6 = 0.1667", "1/3 = 0.3333" )

H_g1 <- c("2/12 = 0.0909", "0.0909 + 1/20 = 0.1409", "0.1409 + 1/19 = 0.1935", "0.1935 + 1/17 = 0.2524", "0.2524 + 1/16 = 0.3149", "0.3149 + 2/15 = 0.4482", "0.4482 + 1/8 = 0.5732", "0.5732 + 1/6 = 0.7399", "0.7399 * 1/3 = 1.0732")

H_NA_g1 <- cbind(fallas_g1, meses_g1, h_g1, H_g1)
colnames(H_NA_g1)<- c("Falla","Meses","$\\hat{h}(t)$","$\\hat{H}_{NA}(t)$")


fallas_g2 <- c(1:16)
meses_g2 <-c(2, 3, 4, 7, 10, 22, 28, 29, 32, 37, 40, 41,
             54, 61, 63, 71)
h_g2 <- c("1/22 = 0.0455", "1/21 = 0.0476", "1/20 = 0.0500", "1/19 = 0.0526", "1/18 = 0.0556", "1/17 = 0.0588", "1/16 = 0.0625", "1/15 = 0.0667", "1/14 =  0.0714", "1/13 = 0.0769", "1/12 = 0.0833", "1/11 = 0.0909", "1/10 = 0.1000", "1/9 = 0.1111", "1/8 = 0.1250", "1/7 = 0.1429")

H_g2 <- c("1/22 = 0.0455", 
          "0.0455 + 1/21 = 0.0931",
          "0.0931 + 1/20 = 0.1431", 
          "0.1431 + 1/19 = 0.1957",
          "0.1957 + 1/18 = 0.2513",
          "0.2513 + 1/17 = 0.3101",
          "0.3101 + 1/16 = 0.3726",
          "0.3726 + 1/15 = 0.4393",
          "0.4393 + 1/14 = 0.5107",
          "0.5107 + 1/13 = 0.5876",
          "0.5876 + 1/12 = 0.6709",
          "0.6709 + 1/11 = 0.7618",
          "0.7618 + 1/10 = 0.8618",
          "0.8618 + 1/9 = 0.9730", 
          "0.9730 + 1/8 = 1.0980", 
          "1.0980 + 1/7 = 1.2408"
        )

H_NA_g2 <- cbind(fallas_g2, meses_g2, h_g2, H_g2)
colnames(H_NA_g2)<- c("Falla","Meses","$\\hat{h}(t)$","$\\hat{H}_{NA}(t)$")

kable(
  list(H_NA_g1, H_NA_g2),
  caption = 'Estimando Nelson-Aalen H(t) grupos 1 y 2',
  booktab = T, 
  align = 'c',
  escape = F
)%>%
  kable_styling(latex_options = "HOLD_position")
``` 
\begin{figure}[H]
  \includegraphics{H_NA.jpeg}
  \caption{Curvas de supervivencia con NA}
\end{figure}


Si se comparan los gráficos y tablas estimadas del Hazard acumulado manualmente con la relación $-log(\hat{S}_{KM}(t))$ y el $\hat{H}_{NA}(t)$. Podemos concluir que dichas descripciones se aproximan mucho. O en pocas palabras que ambas estimaciones nos indican que el tiempo promedio de falla es mucho mayor para el grupo de control respecto al grupo tratado con prednisolona.

\newpage
\section{Ejercicio 5}

Contrastando todo la implementación manual de la estimación del Hazard Integrado $\hat{H}(t)$ usando R como sofware estadístico y el paquete `survival` como descriptor gráfico se obtiene: 


```{r}
data <-read.table(file='CAH.txt',header=T)
df=data.frame(data)

KM_fit <- survfit(Surv(time, status) ~ group, data = df)
g1 <- df[df[,2]==1,]

KM_fit1 <- survfit(Surv(time, status) ~ group, data = g1)

CUMHAZ_1<- -log(KM_fit1$surv)

haz_1 <- data.frame(
  time = c(KM_fit1$time),
#  inverse_KM = CUMHAZ_1,
  N_A = CUMHAZ_1,
  group="1",
  method="Inverse_KM"
)

g2=df[df[,2]==2,]

KM_fit2 <- survfit(Surv(time, status) ~ group, data = g2)

CUMHAZ_2<- -log(KM_fit2$surv)

haz_2 <- data.frame(
  time = c(KM_fit2$time),
#  inverse_KM = CUMHAZ_2,
  N_A=CUMHAZ_2,
  group="2",
  method="Inverse_KM"
)

haz<-rbind(haz_1,haz_2)

plot1<-ggplot(haz, aes(x = time, y = N_A,group=group,color=group)) + 
  geom_step(size=2)+ 
  labs(x = "Meses de seguimiento", 
       y = "Hazard Acumulado",
       title = "Hazard Acumulado usando -Log(KM)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

plot1
```

```{r, warning=FALSE}
h_st1 <- KM_fit1$n.event /  KM_fit1$n.risk
H_est1 <- cumsum(h_st1)

h_st2 <- KM_fit2$n.event /  KM_fit2$n.risk
H_est2 <- cumsum(h_st2)

NA_1 <- data.frame(
  time = c(KM_fit1$time),
#  NA_Est = H_est1,
N_A=H_est1,
  group="1_NA",
  method="N-A"
)

NA_2 <- data.frame(
  time = c(KM_fit2$time),
#  NA_Est = H_est2,
N_A=H_est2,
  group="2_NA",
  method="N-A"
)

NA_<-rbind(NA_1, NA_2)

plot2<-ggplot(NA_, aes(x = time, y = N_A,group=group,color=group)) + 
  geom_step(size=2)+ 
  labs(x = "Meses de seguimiento", 
       y = "Hazard Acumulado",
       title = "Hazard Acumulado usando NA") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
plot2
```

Las estimaciones arrojadas por el software estadístico R y las realizadas manualmente  de $-log(\hat{S}_{KM}(t))$ y el $\hat{H}_{NA}(t)$ del Hazard Acumulado son aproximadamente iguales y ambas nos indican. Que los pacientes que pertenecen al grupo de control tiene una posibilidad mucho mayor de falla en un tiempo menor, que los pacientes que son tratados con prednisolona. Esto quiere decir que se evidencia una mejora en las personas que son expuestas a dicho tratamiento. 


```{r}
all<-rbind(haz, NA_)

#ggplot(all, aes(x = time, y = N_A,group=group,color=group)) + 
#  geom_step(size=2)+ 
#  labs(x = "Meses de seguimiento", 
#       y = "Cumulative Hazard",
#       title = "Cumulative Hazard Function via Inverse NA")

ggplot(all, aes(x = time, y = N_A,group=group,color=method)) + 
  geom_step(size=2)+ 
  labs(x = "Meses de seguimiento", 
       y = "Hazard Acumulado",
       title = "Hazard Acumulado -Log(KM) vs NA") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
```
Del gráfico anterior se busca comparar los dos métodos usados el $-log(\hat{S}_{KM}(t))$ y el $\hat{H}_{NA}(t)$ para calcular el Hazard acumulado. Dichas estimaciones usando el R se asemejan mucho y nos permiten afirmar dichas conclusiones mencionadas con anterioridad. 

\section{Ejercicio 6}

```{r CAH-6}
cah <- read.table("CAH.txt", header = T)
```

Uno de los principales intereses de un estudio medico es determinar si el
tratamiento que está siendo suministrado a sus pacientes sea efectivo
contra la enfermedad en cuestión. En Kirk et al (1980) se le suministra la
droga prednisolona a un grupo de pacientes que sufren hepatitis crónica
activa mientras que a otro grupo de estos no se les suministra dicho
medicamento por lo que surge de manera natural la idea de comparar ambos
grupos con el propósito de investigar si la prednisolona es realmente
efectiva contra la hepatitis crónica activa, para esto se usará 
$Log - Rank$ test el cual contempla las siguientes hipótesis

$$
\begin{cases}
H_0: \forall_t \hspace{.1in} S_1(t) = S_2(t) \\
H_1: \exists_t \hspace{.1in} S_1(t) \neq S_2(t)
\end{cases}
$$
siendo el grupo 1 aquel que recibe el tratamiento mientras que el 2 es
un grupo de control. Se usa como estadístico de prueba

$$
Log-rank = \frac{(O_i - E_i)^2}{Var(O_i - E_i)} \sim \chi_{(k-1)}^2
$$

siendo $k$ el número de grupos, para este caso $k = 2$. Se puede verificar
que esta cantidad es invariante al grupo seleccionado, es decir, su valor
será el mismo sin importar si se calcula con el grupo 1 o 2, sean:

* $O_i$: Valor observado en el grupo $i$
* $E_i$: Valor esperado en el grupo $i$
* $m_{ij}$: Número de fallas en el grupo $i$
* $e_{ij}$: Conteo esperado en cada categoría
* $n_{ij}$: Número de pacientes a efectivos en el grupo $i$ y tiempo $j$

$$
\begin{aligned}
e_{ij} &= \left( \frac{n_{ij}}{n_{1j} + n_{2j}} \right)(m_{1j} + m_{2j}) \\
(O_i - E_i) &= \sum_{j=1}^{\# \ \text{fallas}} (m_{ij} - e_{ij}) \\
Var(O_i - E_i) &= \sum_{j=1}^{\# \ \text{fallas}} \frac{n_{1j} n_{2j} (m_{1j} + m_{2j})(n_{1j} + n_{2j} - m_{1j} - m_{2j})}{(n_{1j} + n_{2j})^2 (n_{1j} + n_{2j} - 1)}
\end{aligned}
$$

Para ilustrar de forma detallada el procedimiento, se mostrará un paso a
paso del mismo.

**Paso 1**

Inicialmente se ordenan todos los tiempos de falla únicos sin distinguir
al grupo que pertenecen obteniendo lo siguiente

```{r tiempos-falla, warning=F}
options(knitr.kable.NA = "")
tj <- select(cah, time) %>%
  unlist() %>%
  as.vector() %>%
  unique() %>% 
  sort()
aux_mat <- matrix(c(tj, NA, NA), nrow = 4, ncol = 10, byrow = T)

kable(aux_mat, booktabs = T, longtable = T, position = "center")
```

**Paso 2**

Luego de ordenar los tiempos únicos, se cuenta el número de fallas por
grupo $m_{ij}$ y el número de pacientes efectivos $n_{ij}$ para cada 
tiempo de falla teniendo en cuenta que cada que exista una nueva falla o
censura dicha cantidad disminuirá como 
$n_{ij} = n_{i(j-1)} - m_{i(j-1)} - q_{i(j-1)}$ con $q_{ij}$ número de
censuras en el grupo $i$ y tiempo $j$. Luego de realizar las cuentas se
obtiene lo siguiente 

```{r paso-2}
# Conteo para el grupo 1
# 56 hay censura
# 96 hay dos fallas
# "Segunda fila" empieza con 125
# 128, 131, 140, 141 hay censura
# Vuelve a haber falla en 143
# 148 hay censura
# 162 hay censura
# 173 y 181 hay censura
m1j <- c(2, 0, 0, 0, 0, 1, rep(0, 7), 1, 0, 0, 0, 1, 0, 1, 2, 
         0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0)

# "Segunda fila" empieza con t = 125 
# n1j <- c(rep(22, 5), rep(20, 8), 19, 18, 18, 18, 17, 17, 16, 14,
#          13, 13, 12, 11, 10, 9, 8, 7, 6, 5, 5, 4, 4, 3, 2, 1, 1)
# "Segunda fila" empieza con t = 96 (n1j = 15)       #   #       #
n1j <- c(22, 20, 20, 20, 20, 20, rep(19, 7), 19, 18, 17, 17, 17, 16, 16,
         15, 13, 12, 12, 11, 10, 9, 8, 7, 6, 5, 4, 4, 3, 3, 2, 1, 0)
                 #                              #     #           #
# Conteo para el grupo 2
# "Primera fila" termina en 71
# 127 hay censura
# 140 hay censura 
# 146 hay censura
# 158 hay censura
# 167 hay censura
# 182 hay censura
m2j <- c(1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)

# "Segunda fila" empieza con 63 
                             #                                   #  
n2j <- c(22, 21, 20, 19, 18, 17, 17, 16, 15, 14, 13, 12, 11, 10, 9, 9, 
         8, 7, 7, 6, 6, 6, 6, 5, 5, 5, 4, 4, 4, 4, 3, 3, 2, 2, 1, 1, 1, 1)
            #     #           #        #           #     #     #
logrank_data <- data.frame(tj, m1j, m2j, n1j, n2j)

kable(cbind(logrank_data[1:19, ], logrank_data[20:38, ])[1:9, ], 
      booktabs = T, longtable = T, escape = F,
      col.names = c("$t_j$", "$m_{1j}$", "$m_{2j}$",
                    "$n_{1j}$", "$n_{2j}$",
                    "$t_j$", "$m_{1j}$", "$m_{2j}$",
                    "$n_{1j}$", "$n_{2j}$"))
kable(cbind(logrank_data[1:19, ], logrank_data[20:38, ])[10:19, ], 
      booktabs = T, longtable = T, escape = F,
      col.names = c("$t_j$", "$m_{1j}$", "$m_{2j}$",
                    "$n_{1j}$", "$n_{2j}$",
                    "$t_j$", "$m_{1j}$", "$m_{2j}$",
                    "$n_{1j}$", "$n_{2j}$"), row.names = F)
```

**Paso 3**

Una vez calculados los $m_{ij}$ y $n_{ij}$ se pueden calcular los
$e_{ij}$ con las formulas presentadas anteriormente, obteniendo lo
siguiente

```{r paso-3}
logrank_data %<>% 
  mutate(e1j = (n1j/(n1j + n2j))*(m1j + m2j),
         e2j = (n2j/(n1j + n2j))*(m1j + m2j))
kable(logrank_data[1:21, ], longtable = T, booktabs = T, escape = F,
      col.names = c("$t_j$", "$m_{1j}$", "$m_{2j}$",
                    "$n_{1j}$", "$n_{2j}$", "$e_{1j}$", "$e_{2j}$"),
      digits = 4)
kable(logrank_data[22:38, ], longtable = T, booktabs = T, escape = F,
      col.names = c("$t_j$", "$m_{1j}$", "$m_{2j}$",
                    "$n_{1j}$", "$n_{2j}$", "$e_{1j}$", "$e_{2j}$"),
      digits = 4, row.names = F)
```

**Paso 4**

Finalmente se calculan los $m_{ij} - e_{ij}$ para estimar la cantidad $O_i - E_i$

```{r paso-4}
logrank_data %<>% 
  mutate(m1j_e1j = m1j - e1j,
         m2j_e2j = m2j - e2j)
final_row <- colSums(logrank_data[1:35, ]) %>% 
  as.vector()
final_row[c(1, 4:5)] <- NA

logrank_data <- rbind(logrank_data, final_row)

kable(logrank_data[1:15, ], longtable = T, booktabs = T, escape = F,
      col.names = c("$t_j$", "$m_{1j}$", "$m_{2j}$", "$n_{1j}$",
                    "$n_{2j}$", "$e_{1j}$", "$e_{2j}$",
                    "$m_{1j} - e_{1j}$", "$m_{2j} - e_{2j}$"),
      digit = 4)
kable(logrank_data[16:39, ], longtable = T, booktabs = T, escape = F,
      col.names = c("$t_j$", "$m_{1j}$", "$m_{2j}$", "$n_{1j}$",
                    "$n_{2j}$", "$e_{1j}$", "$e_{2j}$",
                    "$m_{1j} - e_{1j}$", "$m_{2j} - e_{2j}$"),
      digit = 4, row.names = F)

```

La última fila de la anterior tabla es la suma de cada columna hasta la
falla número 35 la cual corresponde al tiempo $t=168$ puesto que en dicho
momento se presenta la última falla, de aquí se aprecia que 
$(O_2 - E_2) = -(O_1 - E_1)$.

**Paso 5**

Tal como se mencionó previamente, el estadístico $Log-rank$ será el 
mismo sin importar si este es calculado con el grupo 1 o el 2, para la
situación dada se escoge el grupo 2 obteniendo

```{r paso-5, message=F}
num_g2 <- with(logrank_data[1:35, ],
               n1j*n2j*(m1j + m2j)*(n1j + n2j - m1j - m2j))

den_g2 <- with(logrank_data[1:35, ],
               (n1j + n2j)^2 * (n1j + n2j - 1))

O2_E2 <- logrank_data$m2j_e2j[39]
var_g2 <- sum(num_g2/den_g2)
logrank_stat <- O2_E2^2 / var_g2
```


$$
Var(O_2 - E_2) = `r round(var_g2, 4)`
$$

Luego de haber realizado e ilustrado los cálculos, se obtiene \newline
$Log-rank = \frac{(`r round(O2_E2, 4)`)^2}{Var(O_2 - E_2)} =\frac{`r round(O2_E2^2, 4)`}{`r round(var_g2, 4)`} = `r round(logrank_stat, 4)`$
y debido a que $Log-rank \sim \chi^2_{(1)}$ se calcula el valor-p como
$\mathbb{P}\left(\chi^2_{(1)} > `r round(logrank_stat, 4)`\right) = `r pchisq(logrank_stat, 1, lower.tail = F) %>% round(4)`$ 
con lo cual a un nivel de significancia usual de 0.05 se rechaza $H_0$
y se concluye que existe evidencia muestral suficiente para pensar 
$S_1(t) \neq S_2(t)$ para algún $t$.

En términos del problema, esto quiere decir que existe un grupo de
pacientes el cual tiene tiempos de supervivencia mayores al otro sin
embargo no se sabe cual. Si el grupo con mayor tiempo de supervivencia es
aquel que esta siendo medicado con prednisolona se concluiría que la droga
es efectiva para tratar la hepatitis crónica activa de lo contrario se
concluiría que el tratamiento con prednisolona empeora el estado de salud
de los pacientes.

\section{Ejercicio 7}

El proceso realizado en el ejercicio 6 es importante conocerlo para evitar
el efecto caja negra al usar funciones sin entender que están haciendo
internamente. Luego de ilustrar el proceso manual para entender de forma
adecuada el proceso, este es realizado con el software computacional R el
cual simplifica de manera sustancial el trabajo, para este propósito se
usaran las funciones `Surv()` y `survdiff()` del paquete `survival`.

Inicialmente se debe usar la función `Surv()` para crear un objeto de la
clase survival el cual posteriormente será usado como variable respuesta.
Luego de crear el objeto survival, este es usado en la función 
`survdiff()` la cual recibe una formula como primer argumento  y en dicha
formula se modela el objeto survival en función de los grupos. 

Finalmente se obtienen los siguientes resultados:

```{r conR-6}
auto_logrank <- survdiff(Surv(time, status) ~ group, data = cah)

result_logrank <- data.frame(N = c(22, 22),
                             Observado = c(11, 16),
                             Esperado = c(16.3, 10.7),
                             O_E = c(1.74, 2.67),
                             O_V = c(4.59, 4.59))
kable(result_logrank, longtable = T, booktabs = T, escape = F,
      col.names = c("N", "Observado", "Esperado",
                    "$\\frac{(O-E)^2}{E}$", "$\\frac{(O-E)^2}{V}$"))
```

$$
\chi^2 = 4.6 \ \text{ con 1 grado de libertad, p = 0.03}
$$
El cual concuerda con el resultado obtenido manualmente.

Finalmente, para descubrir cual de los dos grupos tiene mayor tiempo de
supervivencia se grafican las curvas de supervivencia estimadas con el
método de Kaplan - Meier

```{r survplot-6}
KM_cah <- survfit(Surv(time, status) ~ group, data = cah)

# El buen stack overflow nunca falla xd
custom_theme <- function() {
  theme_minimal() %+replace%
    theme(
      plot.title = element_text(hjust=0.5)
    )
}
ggsurvplot(KM_cah, data = cah,
           surv.median.line = "hv",
           legend.title = "Grupo",
           legend.labs = c("Prednisolona", "Control"),
           title = "Curvas de supervivencia estimadas por KM",
           xlab = "Tiempo", ylab = "Probabilidad de supervivencia",
           ggtheme = custom_theme())
```

Aquí se puede notar claramente que el grupo que esta recibiendo la droga
tiene mayor probabilidad de supervivencia respecto al grupo de control;
también se aprecia la gran diferencia entre las lineas medianas de los dos
grupos, mientras la probabilidad de supervivencia es menor de 0.5 en el
grupo de control para tiempos aproximadamente mayores a 40, en el grupo 
que recibe el tratamiento dicha probabilidad es menor a 0.5 para tiempos
aproximadamente mayores a 148 por lo que se puede concluir que el
tratamiento con prednisolona es efectivo para combatir la hepatitis 
crónica activa.

