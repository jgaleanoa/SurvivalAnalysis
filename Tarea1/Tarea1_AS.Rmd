---
header-includes:
- \usepackage{longtable}
- \usepackage[utf8]{inputenc}
- \usepackage[spanish]{babel}\decimalpoint
- \setlength{\parindent}{1.25cm}
- \usepackage{amsmath}
- \usepackage{xcolor}
- \usepackage{cancel}
- \usepackage{array}
- \usepackage{float}
- \usepackage{multirow}
output:
  pdf_document: 
    number_sections: yes
fontsize: 12pt
papersize: letter
geometry: margin = 1in
language: "es"
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, fig.align = "center",
                      fig.height = 3.2, fig.pos = "H")
library(kableExtra)
library(knitr)
library(tidyverse)
library(magrittr)
library(latex2exp)
library(ggfortify)
library(survival)
```

```{=tex}
\input{titlepage}
\thispagestyle{empty}
\tableofcontents
\newpage
\thispagestyle{empty}
\listoffigures
\newpage
```

```{=tex}
\pagestyle{myheadings}
\setcounter{page}{4}
```

\section{Ejercicio 1}

\section{Ejercicio 2}

\section{Ejercicio 3}

\section{Ejercicio 4}

\section{Ejercicio 5}

\section{Ejercicio 6}

```{r CAH-6}
cah <- read.table("CAH.txt", header = T)
```

Uno de los principales intereses de un estudio medico es determinar si el tratamiento que está siendo suministrado a sus pacientes sea efectivo contra la enfermedad en cuestión. En Kirk et al (1980) se le suministra la droga prednisolona a un grupo de pacientes que sufren hepatitis crónica activa mientras que a otro grupo de estos no se les suministra dicho medicamento por lo que surge de manera natural la idea de comparar ambos grupos con el propósito de investigar si la prednisolona es realmente efectiva contra la hepatitis crónica activa, para esto se usará $Log - Rank$ test el cual contempla las siguientes hipótesis

$$
\begin{cases}
H_0: \forall_t \hspace{.1in} S_1(t) = S_2(t) \\
H_1: \exists_t \hspace{.1in} S_1(t) \neq S_2(t)
\end{cases}
$$
Se usa como estadístico de prueba

$$
Log-rank = \frac{(O_i - E_i)^2}{Var(O_i - E_i)} \sim \chi_{(k-1)}^2
$$

siendo $k$ el número de grupos, para este caso $k = 2$. Se puede verificar que esta cantidad es invariante al grupo seleccionado, es decir, su valor será el mismo sin importar si se calcula con el grupo 1 o 2, sean:

* $O_i$: Valor observado en el grupo $i$
* $E_i$: Valor esperado en el grupo $i$
* $m_{ij}$: Número de fallas en el grupo $i$
* $e_{ij}$: Conteo esperado en cada categoría
* $n_{ij}$: Número de pacientes a efectivos en el grupo $i$ y tiempo $j$

$$
\begin{aligned}
e_{ij} &= \left( \frac{n_{ij}}{n_{1j} + n_{2j}} \right)(m_{1j} + m_{2j}) \\
(O_i - E_i) &= \sum_{j=1}^{\# \ \text{fallas}} (m_{ij} - e_{ij}) \\
Var(O_i - E_i) &= \sum_{j=1}^{\# \ \text{fallas}} \frac{n_{1j} n_{2j} (m_{1j} + m_{2j})(n_{1j} + n_{2j} - m_{1j} - m_{2j})}{(n_{1j} + n_{2j})^2 (n_{1j} + n_{2j} - 1)}
\end{aligned}
$$

Para ilustrar de forma detallada el procedimiento, se mostrará un paso a paso del mismo.

**Paso 1**

Inicialmente se ordenan todos los tiempos de falla únicos sin distinguir al grupo que pertenecen obteniendo lo siguiente

```{r tiempos-falla, warning=F}
options(knitr.kable.NA = "")
tj <- select(cah, time) %>%
  unlist() %>%
  as.vector() %>%
  unique() %>% 
  sort()
aux_mat <- matrix(c(tj, NA, NA), nrow = 4, ncol = 10, byrow = T)

kable(aux_mat, booktabs = T, longtable = T, position = "center")
```

**Paso 2**

Luego de ordenar los tiempos únicos, se cuenta el número de fallas por grupo $m_{ij}$ y el número de pacientes efectivos $n_{ij}$ para cada tiempo de falla teniendo en cuenta que cada que exista una nueva falla o censura dicha cantidad disminuirá como $n_{ij} = n_{i(j-1)} - m_{i(j-1)} - q_{i(j-1)}$ con $q_{ij}$ número de censuras en el grupo $i$ y tiempo $j$. Luego de realizar las cuentas se obtiene lo siguiente 

```{r paso-2}
# Conteo para el grupo 1
# 56 hay censura
# 96 hay dos fallas
# "Segunda fila" empieza con 125
# 128, 131, 140, 141 hay censura
# Vuelve a haber falla en 143
# 148 hay censura
# 162 hay censura
# 173 y 181 hay censura
m1j <- c(2, 0, 0, 0, 0, 1, rep(0, 7), 1, 0, 0, 0, 1, 0, 1, 2, 
         0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0)

# "Segunda fila" empieza con t = 125 
# n1j <- c(rep(22, 5), rep(20, 8), 19, 18, 18, 18, 17, 17, 16, 14,
#          13, 13, 12, 11, 10, 9, 8, 7, 6, 5, 5, 4, 4, 3, 2, 1, 1)
# "Segunda fila" empieza con t = 96 (n1j = 15)       #   #       #
n1j <- c(22, 20, 20, 20, 20, 20, rep(19, 7), 19, 18, 17, 17, 17, 16, 16,
         15, 13, 12, 12, 11, 10, 9, 8, 7, 6, 5, 4, 4, 3, 3, 2, 1, 0)
                 #                              #     #           #
# Conteo para el grupo 2
# "Primera fila" termina en 71
# 127 hay censura
# 140 hay censura 
# 146 hay censura
# 158 hay censura
# 167 hay censura
# 182 hay censura
m2j <- c(1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)

# "Segunda fila" empieza con 63 
                             #                                   #  
n2j <- c(22, 21, 20, 19, 18, 17, 17, 16, 15, 14, 13, 12, 11, 10, 9, 9, 
         8, 7, 7, 6, 6, 6, 6, 5, 5, 5, 4, 4, 4, 4, 3, 3, 2, 2, 1, 1, 1, 1)
            #     #           #        #           #     #     #
logrank_data <- data.frame(tj, m1j, m2j, n1j, n2j)

kable(cbind(logrank_data[1:19, ], logrank_data[20:38, ])[1:13, ], 
      booktabs = T, longtable = T, escape = F,
      col.names = c("$t_j$", "$m_{1j}$", "$m_{2j}$",
                    "$n_{1j}$", "$n_{2j}$",
                    "$t_j$", "$m_{1j}$", "$m_{2j}$",
                    "$n_{1j}$", "$n_{2j}$"))
kable(cbind(logrank_data[1:19, ], logrank_data[20:38, ])[14:19, ], 
      booktabs = T, longtable = T, escape = F,
      col.names = c("$t_j$", "$m_{1j}$", "$m_{2j}$",
                    "$n_{1j}$", "$n_{2j}$",
                    "$t_j$", "$m_{1j}$", "$m_{2j}$",
                    "$n_{1j}$", "$n_{2j}$"), row.names = F)
```

**Paso 3**

Una vez calculados los $m_{ij}$ y $n_{ij}$ se pueden calcular los $e_{ij}$ con las formulas presentadas anteriormente, obteniendo lo siguiente

```{r paso-3}
logrank_data %<>% 
  mutate(e1j = (n1j/(n1j + n2j))*(m1j + m2j),
         e2j = (n2j/(n1j + n2j))*(m1j + m2j))
kable(logrank_data[1:25, ], longtable = T, booktabs = T, escape = F,
      col.names = c("$t_j$", "$m_{1j}$", "$m_{2j}$",
                    "$n_{1j}$", "$n_{2j}$", "$e_{1j}$", "$e_{2j}$"),
      digits = 4)
kable(logrank_data[26:38, ], longtable = T, booktabs = T, escape = F,
      col.names = c("$t_j$", "$m_{1j}$", "$m_{2j}$",
                    "$n_{1j}$", "$n_{2j}$", "$e_{1j}$", "$e_{2j}$"),
      digits = 4, row.names = F)
```

**Paso 4**

Finalmente se calculan los $m_{ij} - e_{ij}$ para estimar la cantidad $O_i - E_i$

```{r paso-4}
logrank_data %<>% 
  mutate(m1j_e1j = m1j - e1j,
         m2j_e2j = m2j - e2j)
final_row <- colSums(logrank_data) %>% 
  as.vector()
final_row[1] <- NA

logrank_data <- rbind(logrank_data, final_row)

kable(logrank_data[1:20, ], longtable = T, booktabs = T, escape = F,
      col.names = c("$t_j$", "$m_{1j}$", "$m_{2j}$", "$n_{1j}$",
                    "$n_{2j}$", "$e_{1j}$", "$e_{2j}$",
                    "$m_{1j} - e_{1j}$", "$m_{2j} - e_{2j}$"),
      digit = 4)
kable(logrank_data[21:39, ], longtable = T, booktabs = T, escape = F,
      col.names = c("$t_j$", "$m_{1j}$", "$m_{2j}$", "$n_{1j}$",
                    "$n_{2j}$", "$e_{1j}$", "$e_{2j}$",
                    "$m_{1j} - e_{1j}$", "$m_{2j} - e_{2j}$"),
      digit = 4, row.names = F)

```

De esta última tabla se apreciar que $(O_2 - E_2) = -(O_1 - E_1)$.

**Paso 5**

Tal como se mencionó previamente, el estadístico $Log-rank$ será el mismo sin importar si este es calculado con el grupo 1 o el 2, para la situación dada se escoge el grupo 2 obteniéndose 

```{r paso-5, message=F}
num_g2 <- with(logrank_data[-39, ],
               n1j*n2j*(m1j + m2j)*(n1j + n2j - m1j - m2j))

den_g2 <- with(logrank_data[-39, ],
               (n1j + n2j)^2 * (n1j + n2j - 1))

O2_E2 <- logrank_data$m2j_e2j[39]
var_g2 <- sum(num_g2/den_g2)
logrank_stat <- O2_E2^2 / var_g2
```


$$
Var(O_2 - E_2) = `r round(var_g2, 4)`
$$
Luego de haber realizado e ilustrado los cálculos, se obtiene
$Log-rank = \frac{`r round(O2_E2^2, 4)`}{`r round(var_g2, 4)`} = `r round(logrank_stat, 4)`$ 

\section{Ejercicio 7}

```{r logrank-auto, eval=F}
survdiff(Surv(time, status) ~ group, data = cah)
```



